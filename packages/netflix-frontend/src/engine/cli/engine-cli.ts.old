// engine-cli.ts
type MovieStatus = 'UNKNOWN' | 'AVAILABLE' | 'UNAVAILABLE'

type Context = {
  movie: {
    id: number
    status: MovieStatus
  }
  retryCount: number
  scenario: 'api_success' | 'api_fail'
}

type Result = { type: 'SUCCESS' } | { type: 'FAIL'; reason: string } | { type: 'SHOW_SIMILAR' }

type Action = {
  id: string
  when: (ctx: Context) => boolean
  weight: number
  execute: (ctx: Context) => Result
  onUse?: (ctx: Context) => void
}

function trace(label: string) {
  console.log(`[TRACE] ${label}`)
}

// ---------------- ACTIONS ----------------

const fetchFromApi: Action = {
  id: 'fetchFromApi',
  when: ctx => ctx.movie.status === 'UNKNOWN' && ctx.retryCount < 2,
  weight: 10,
  execute: ctx => {
    if (ctx.scenario === 'api_success') {
      return { type: 'SUCCESS' }
    }
    return { type: 'FAIL', reason: 'API_TIMEOUT' }
  },
  onUse: () => trace('API_CALL')
}

const proposeSimilar: Action = {
  id: 'proposeSimilar',
  when: ctx => ctx.movie.status === 'UNAVAILABLE',
  weight: 20,
  execute: () => ({ type: 'SHOW_SIMILAR' }),
  onUse: () => trace('SHOW_SIMILAR')
}

const actions: Action[] = [fetchFromApi, proposeSimilar]

// ---------------- ENGINE ----------------

function runEngine(initialContext: Context) {
  let ctx = { ...initialContext }

  console.log('===================================')
  console.log(`SCENARIO: ${ctx.scenario}`)
  console.log('===================================')

  let step = 0
  let running = true

  while (running && step < 5) {
    step++

    console.log('\n[CONTEXT]')
    console.log(ctx)

    const available = actions.filter(a => a.when(ctx)).sort((a, b) => a.weight - b.weight)

    if (available.length === 0) {
      console.log('\n[NO ACTION AVAILABLE]')
      break
    }

    console.log('\n[ACTIONS AVAILABLE]')
    available.forEach(a => console.log(`- ${a.id} (weight: ${a.weight})`))

    const selected = available[0]

    console.log(`\n[SELECTED ACTION]\nâ†’ ${selected.id}`)

    selected.onUse?.(ctx)

    const result = selected.execute(ctx)

    console.log('\n[RESULT]')
    console.log(result)

    // ---- CONTEXT UPDATE ----
    if (result.type === 'SUCCESS') {
      ctx.movie.status = 'AVAILABLE'
      running = false
    }

    if (result.type === 'FAIL') {
      ctx.retryCount++
      ctx.movie.status = 'UNAVAILABLE'
    }

    if (result.type === 'SHOW_SIMILAR') {
      running = false
    }
  }

  console.log('\n=== END ===')
}

// ---------------- CLI ----------------

const scenario = process.argv[2] as 'api_success' | 'api_fail'

if (!scenario) {
  console.log('Usage: ts-node engine-cli.ts api_success|api_fail')
  process.exit(1)
}

runEngine({
  movie: { id: 278, status: 'UNKNOWN' },
  retryCount: 0,
  scenario
})
